
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#2196f3">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
    <link rel="apple-touch-icon" href="_static/images/apple-icon-152x152.png"/>
  
  
    <title>Use cases &#8212; Python array API standard 2022.12 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Assumptions" href="assumptions.html" />
    <link rel="prev" title="Purpose and scope" href="purpose_and_scope.html" />
  
    <link rel="apple-touch-icon" href="_static/images/apple-icon-152x152.png"/>
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=green>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#use_cases" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Python array API standard 2022.12 documentation"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">&#xe869</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Python array API standard</span>
          <span class="md-header-nav__topic"> Use cases </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../versions.json",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Array API standard</a></li>
            
            <li class="md-tabs__item"><a href="https://data-apis.org" class="md-tabs__link">Consortium for Python Data API Standards</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Python array API standard 2022.12 documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">&#xe869</i>
      
    </a>
    <a href="index.html"
       title="Python array API standard 2022.12 documentation">Python array API standard</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Context</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="purpose_and_scope.html" class="md-nav__link">Purpose and scope</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> Use cases </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">Use cases</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#use-cases--page-root" class="md-nav__link">Use cases</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#types-of-use-cases" class="md-nav__link">Types of use cases</a>
        </li>
        <li class="md-nav__item"><a href="#concrete-use-cases" class="md-nav__link">Concrete use cases</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#use-case-1-add-hardware-accelerator-and-distributed-support-to-scipy" class="md-nav__link">Use case 1: add hardware accelerator and distributed support to SciPy</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-2-simplify-einops-by-removing-the-backend-system" class="md-nav__link">Use case 2: simplify einops by removing the backend system</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-3-adding-a-python-api-to-xtensor" class="md-nav__link">Use case 3: adding a Python API to xtensor</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-4-make-jit-compilation-of-array-computations-easier-and-more-robust" class="md-nav__link">Use case 4: make JIT compilation of array computations easier and more robust</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#types-of-use-cases" class="md-nav__link">Types of use cases</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#concrete-use-cases" class="md-nav__link">Concrete use cases</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="assumptions.html" class="md-nav__link">Assumptions</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">API</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="design_topics/index.html" class="md-nav__link">Design topics & constraints</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="future_API_evolution.html" class="md-nav__link">Future API standard evolution</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="API_specification/index.html" class="md-nav__link">API specification</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="extensions/index.html" class="md-nav__link">Extensions</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Methodology and Usage</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="usage_data.html" class="md-nav__link">Usage Data</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="verification_test_suite.html" class="md-nav__link">Verification - test suite</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="benchmark_suite.html" class="md-nav__link">Benchmark suite</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Other</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="changelog.html" class="md-nav__link">Changelog per API standard version</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="license.html" class="md-nav__link">License</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#use-cases--page-root" class="md-nav__link">Use cases</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#types-of-use-cases" class="md-nav__link">Types of use cases</a>
        </li>
        <li class="md-nav__item"><a href="#concrete-use-cases" class="md-nav__link">Concrete use cases</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#use-case-1-add-hardware-accelerator-and-distributed-support-to-scipy" class="md-nav__link">Use case 1: add hardware accelerator and distributed support to SciPy</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-2-simplify-einops-by-removing-the-backend-system" class="md-nav__link">Use case 2: simplify einops by removing the backend system</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-3-adding-a-python-api-to-xtensor" class="md-nav__link">Use case 3: adding a Python API to xtensor</a>
        </li>
        <li class="md-nav__item"><a href="#use-case-4-make-jit-compilation-of-array-computations-easier-and-more-robust" class="md-nav__link">Use case 4: make JIT compilation of array computations easier and more robust</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="use-cases">
<span id="id1"></span><h1 id="use-cases--page-root">Use cases<a class="headerlink" href="#use-cases--page-root" title="Permalink to this headline">¶</a></h1>
<p>Use cases inform the requirements for, and design choices made in, this array
API standard. This section first discusses what types of use cases are
considered, and then works out a few concrete use cases in more detail.</p>
<section id="types-of-use-cases">
<h2 id="types-of-use-cases">Types of use cases<a class="headerlink" href="#types-of-use-cases" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Packages that depend on a specific array library currently, and would like
to support multiple of them (e.g. for GPU or distributed array support, for
improved performance, or for reaching a wider user base).</p></li>
<li><p>Writing new libraries/tools that wrap multiple array libraries.</p></li>
<li><p>Projects that implement new types of arrays with, e.g., hardware-specific
optimizations or auto-parallelization behavior, and need an API to put on
top that is familiar to end users.</p></li>
<li><p>End users that want to switch from one library to another without learning
about all the small differences between those libraries.</p></li>
</ul>
</section>
<section id="concrete-use-cases">
<h2 id="concrete-use-cases">Concrete use cases<a class="headerlink" href="#concrete-use-cases" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#use-case-scipy"><span class="std std-ref">Use case 1: add hardware accelerator and distributed support to SciPy</span></a></p></li>
<li><p><a class="reference internal" href="#use-case-einops"><span class="std std-ref">Use case 2: simplify einops by removing the backend system</span></a></p></li>
<li><p><a class="reference internal" href="#use-case-xtensor"><span class="std std-ref">Use case 3: adding a Python API to xtensor</span></a></p></li>
<li><p><a class="reference internal" href="#use-case-numba"><span class="std std-ref">Use case 4: make JIT compilation of array computations easier and more robust</span></a></p></li>
</ul>
<section id="use-case-1-add-hardware-accelerator-and-distributed-support-to-scipy">
<span id="use-case-scipy"></span><h3 id="use-case-1-add-hardware-accelerator-and-distributed-support-to-scipy">Use case 1: add hardware accelerator and distributed support to SciPy<a class="headerlink" href="#use-case-1-add-hardware-accelerator-and-distributed-support-to-scipy" title="Permalink to this headline">¶</a></h3>
<p>When surveying a representative set of advanced users and research software
engineers in 2019 (for <a class="reference external" href="https://figshare.com/articles/Mid-Scale_Research_Infrastructure_-_The_Scientific_Python_Ecosystem/8009441">this NSF proposal</a>),
the single most common pain point brought up about SciPy was performance.</p>
<p>SciPy heavily relies on NumPy (its only non-optional runtime dependency).
NumPy provides an array implementation that’s in-memory, CPU-only and
single-threaded. Common performance-related wishes users have are:</p>
<ul class="simple">
<li><p>parallel algorithms (can be multi-threaded or multiprocessing based)</p></li>
<li><p>support for distributed arrays (with Dask in particular)</p></li>
<li><p>support for GPUs and other hardware accelerators (shortened to just “GPU”
in the rest of this use case)</p></li>
</ul>
<p>Some parallelism can be supported in SciPy, it has a <code class="docutils literal notranslate"><span class="pre">workers</span></code> keyword
(similar to scikit-learn’s <code class="docutils literal notranslate"><span class="pre">n_jobs</span></code> keyword) that allows specifying to use
parallelism in some algorithms. However SciPy itself will not directly start
depending on a GPU or distributed array implementation, or contain (e.g.)
CUDA code - that’s not maintainable given the resources for development.
<em>However</em>, there is a way to provide distributed or GPU support. Part of the
solution is provided by NumPy’s “array protocols” (see <a class="reference external" href="https://github.com/data-apis/array-api/issues/1">gh-1</a>), that allow
dispatching to other array implementations. The main problem then becomes how
to know whether this will work with a particular distributed or GPU array
implementation - given that there are zero other array implementations that
are even close to providing full NumPy compatibility - without adding that
array implementation as a dependency.</p>
<p>It’s clear that SciPy functionality that relies on compiled extensions (C,
C++, Cython, Fortran) directly can’t easily be run on another array library
than NumPy (see <a class="reference internal" href="design_topics/C_API.html"><span class="doc std std-doc">C API</span></a> for more details about this topic). Pure Python
code can work though. There’s two main possibilities:</p>
<ol class="arabic simple">
<li><p>Testing with another package, manually or in CI, and simply provide a list
of functionality that is found to work. Then make ad-hoc fixes to expand
the set that works.</p></li>
<li><p>Start relying on a well-defined subset of the NumPy API (or a new
NumPy-like API), for which compatibility is guaranteed.</p></li>
</ol>
<p>Option (2) seems strongly preferable, and that “well-defined subset” is <em>what
an API standard should provide</em>. Testing will still be needed, to ensure there
are no critical corner cases or bugs between array implementations, however
that’s then a very tractable task.</p>
<p>As a concrete example, consider the spectral analysis functions in <code class="docutils literal notranslate"><span class="pre">scipy.signal</span></code>.
All of those functions (e.g., <code class="docutils literal notranslate"><span class="pre">periodogram</span></code>, <code class="docutils literal notranslate"><span class="pre">spectrogram</span></code>, <code class="docutils literal notranslate"><span class="pre">csd</span></code>, <code class="docutils literal notranslate"><span class="pre">welch</span></code>, <code class="docutils literal notranslate"><span class="pre">stft</span></code>,
<code class="docutils literal notranslate"><span class="pre">istft</span></code>) are pure Python - with the exception of <code class="docutils literal notranslate"><span class="pre">lombscargle</span></code> which is ~40
lines of Cython - and uses NumPy function calls, array attributes and
indexing. The beginning of each function could be changed to retrieve the
module that implements the array API standard for the given input array type,
and then functions from that module could be used instead of NumPy functions.</p>
<p>If the user has another array type, say a CuPy or PyTorch array <code class="docutils literal notranslate"><span class="pre">x</span></code> on their
GPU, doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>will result in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For CuPy</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="nb">object</span> <span class="n">__array__</span> <span class="n">method</span> <span class="ow">not</span> <span class="n">producing</span> <span class="n">an</span> <span class="n">array</span>

<span class="c1"># For PyTorch</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">can</span><span class="s1">'t convert cuda:0 device type tensor to numpy.</span>
</pre></div>
</div>
<p>and therefore the user will have to explicitly convert to and from a
<code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> (which is quite inefficient):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For CuPy</span>
<span class="n">x_np</span> <span class="o">=</span> <span class="n">cupy</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">freq</span><span class="p">,</span> <span class="n">Pxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cupy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x_np</span><span class="p">))</span>

<span class="c1"># For PyTorch</span>
<span class="n">x_np</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="c1"># Note: ends up with tensors on CPU, may still have to move them back</span>
<span class="n">freq</span><span class="p">,</span> <span class="n">Pxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x_np</span><span class="p">))</span>
</pre></div>
</div>
<p>This code will look a little different for each array library. The end goal
here is to be able to write this instead as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">freq</span><span class="p">,</span> <span class="n">Pxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>and have <code class="docutils literal notranslate"><span class="pre">freq</span></code>, <code class="docutils literal notranslate"><span class="pre">Pxx</span></code> be arrays of the same type and on the same device as <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This type of use case applies to many other libraries, from scikit-learn
and scikit-image to domain-specific libraries like AstroPy and
scikit-bio, to code written for a single purpose or user.</p>
</div>
</section>
<section id="use-case-2-simplify-einops-by-removing-the-backend-system">
<span id="use-case-einops"></span><h3 id="use-case-2-simplify-einops-by-removing-the-backend-system">Use case 2: simplify einops by removing the backend system<a class="headerlink" href="#use-case-2-simplify-einops-by-removing-the-backend-system" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/arogozhnikov/einops">einops</a> is a library that provides flexible tensor operations and supports many array libraries (NumPy, TensorFlow, PyTorch, CuPy, MXNet, JAX).
Most of the code in <code class="docutils literal notranslate"><span class="pre">einops</span></code> is:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/arogozhnikov/einops/blob/master/einops/einops.py">einops.py</a>
contains the functions it offers as public API (<code class="docutils literal notranslate"><span class="pre">rearrange</span></code>, <code class="docutils literal notranslate"><span class="pre">reduce</span></code>, <code class="docutils literal notranslate"><span class="pre">repeat</span></code>).</p></li>
<li><p><a class="reference external" href="https://github.com/arogozhnikov/einops/blob/master/einops/_backends.py">_backends.py</a>
contains the glue code needed to support that many array libraries.</p></li>
</ul>
<p>The amount of code in each of those two files is almost the same (~550 LoC each).
The typical pattern in <code class="docutils literal notranslate"><span class="pre">einops.py</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">get_backend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>With a standard array API, the <code class="docutils literal notranslate"><span class="pre">_backends.py</span></code> glue layer could almost completely disappear,
because the purpose it serves (providing a unified interface to array operations from each
of the supported backends) is already addressed by the array API standard.
Hence the complete <code class="docutils literal notranslate"><span class="pre">einops</span></code> code base could be close to 50% smaller, and easier to maintain or add to.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Other libraries that have a similar backend system to support many array libraries
include <a class="reference external" href="https://github.com/tensorly/tensorly">TensorLy</a>, the (now discontinued)
multi-backend version of <a class="reference external" href="https://github.com/keras-team/keras">Keras</a>,
<a class="reference external" href="https://github.com/Quansight-Labs/unumpy">Unumpy</a> and
<a class="reference external" href="https://github.com/jonasrauber/eagerpy">EagerPy</a>. Many end users and
organizations will also have such glue code - it tends to be needed whenever
one tries to support multiple array types in a single API.</p>
</div>
</section>
<section id="use-case-3-adding-a-python-api-to-xtensor">
<span id="use-case-xtensor"></span><h3 id="use-case-3-adding-a-python-api-to-xtensor">Use case 3: adding a Python API to xtensor<a class="headerlink" href="#use-case-3-adding-a-python-api-to-xtensor" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/xtensor-stack/xtensor">xtensor</a> is a C++ array library
that is NumPy-inspired and provides lazy arrays. It has Python (and Julia and R)
bindings, however it does not have a Python array API.</p>
<p>Xtensor aims to follow NumPy closely, however it only implements a subset of functionality
and documents some API differences in
<a class="reference external" href="https://xtensor.readthedocs.io/en/latest/numpy-differences.html">Notable differences with NumPy</a>.</p>
<p>Note that other libraries document similar differences, see for example
<a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.numpy.html">this page for JAX</a> and
<a class="reference external" href="https://www.tensorflow.org/guide/tf_numpy">this page for TensorFlow</a>.</p>
<p>Each time an array library author designs a new API, they have to choose (a)
what subset of NumPy makes sense to implement, and (b) where to deviate
because NumPy’s API for a particular function is suboptimal or the semantics
don’t fit their execution model.</p>
<p>This array API standard aims to provide an API that can be readily adopted,
without having to make the above-mentioned choices.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>XND is another array library, written in C, that still needs a Python API.
Array implementations in other languages are often in a similar situation,
and could translate this array API standard 1:1 to their language.</p>
</div>
</section>
<section id="use-case-4-make-jit-compilation-of-array-computations-easier-and-more-robust">
<span id="use-case-numba"></span><h3 id="use-case-4-make-jit-compilation-of-array-computations-easier-and-more-robust">Use case 4: make JIT compilation of array computations easier and more robust<a class="headerlink" href="#use-case-4-make-jit-compilation-of-array-computations-easier-and-more-robust" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/numba/numba">Numba</a> is a Just-In-Time (JIT) compiler for
numerical functions in Python; it is NumPy-aware. <a class="reference external" href="https://pypy.org">PyPy</a>
is an implementation of Python with a JIT at its core; its NumPy support relies
on running NumPy itself through a compatibility layer (<code class="docutils literal notranslate"><span class="pre">cpyext</span></code>), while a
previous attempt to implement NumPy support directly was unsuccessful.</p>
<p>Other array libraries may have an internal JIT (e.g., TensorFlow, PyTorch,
JAX, MXNet) or work with an external JIT like
<a class="reference external" href="https://www.tensorflow.org/xla">XLA</a> or <a class="reference external" href="https://tvm.apache.org/docs/vta/index.html">VTA</a>.</p>
<p>Numba currently has to jump through some hoops to accommodate NumPy’s casting rules
and may not attain full compatibility with NumPy in some cases - see, e.g.,
<a class="reference external" href="https://github.com/numba/numba/issues/4749">this</a> or
<a class="reference external" href="https://github.com/numba/numba/issues/5907">this</a> example issue regarding (array) scalar
return values.</p>
<p>An <a class="reference external" href="https://twitter.com/esc___/status/1295389487485333505">explicit suggestion from a Numba developer</a>
for this array API standard was:</p>
<blockquote>
<div><p>for JIT compilers (e.g. Numba) it will be important, that the type of the
returned value(s) depends only on the <em>types</em> of the input but not on the
<em>values</em>.</p>
</div></blockquote>
<p>A concrete goal for this use case is to have better matching between
JIT-compiled and non-JIT execution. Here is an example from the Numba code
base, the need for which should be avoided in the future:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">cfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">pyfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="c1"># Check the power operation conserved the input's dtype</span>
    <span class="c1"># (this is different from Numpy, whose behaviour depends on</span>
    <span class="c1">#  the *values* of the arguments -- see PyArray_CanCastArrayTo).</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="purpose_and_scope.html" title="Purpose and scope"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Purpose and scope </span>
              </div>
            </a>
          
          
            <a href="assumptions.html" title="Assumptions"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Assumptions </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2020-2022, Consortium for Python Data API Standards.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>